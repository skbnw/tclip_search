# パフォーマンス最適化ガイド

## 🚀 実装済みの最適化

### 1. キャッシュの延長
- ✅ `list_all_master_data`: TTL 10分 → **1時間**に延長
- ✅ `get_search_options`: TTL 10分 → **1時間**に延長
- 初回アクセス後は1時間キャッシュが有効

### 2. 進捗表示の追加
- ✅ データ読み込み時の進捗バー
- ✅ キーワード検索時の進捗表示
- ユーザーに処理状況を明確に表示

### 3. 検索処理の最適化
- ✅ 全文テキスト検索を優先（高速）
- ✅ チャンク検索は全文テキストにマッチしない場合のみ実行

---

## 📊 さらなる最適化案

### 1. データの事前読み込み（推奨）

**問題**: 初回アクセス時に全データを読み込むため時間がかかる

**解決策**: 
- アプリ起動時にバックグラウンドでデータを読み込む
- または、検索条件が入力されるまでデータ読み込みを遅延

### 2. ページネーションの導入

**問題**: 大量の検索結果を一度に表示するため重い

**解決策**:
- 検索結果を20件ずつ表示
- 「次の20件」ボタンで追加読み込み

### 3. インデックスファイルの活用

**問題**: 全データを毎回S3から取得している

**解決策**:
- メタデータのみのインデックスファイルを作成
- 検索時はインデックスファイルのみを使用
- 詳細表示時のみ完全なデータを取得

### 4. 並列処理の導入

**問題**: ファイルの読み込みが順次処理

**解決策**:
- `concurrent.futures`を使用して並列読み込み
- S3からの複数ファイルを同時に取得

### 5. Streamlit Cloudのリソース制限

**問題**: Streamlit Cloudの無料プランにはリソース制限がある

**解決策**:
- **Streamlit Teamプラン**へのアップグレード（CPU・メモリ増加）
- または、**AWS EC2/ECS**などへの移行検討

---

## 🔧 即座に実装可能な最適化

### オプション1: 検索条件入力時にデータ読み込みを遅延

検索ボタンを押すまでデータを読み込まないように変更：

```python
# 検索フォーム表示時はデータを読み込まない
# 検索ボタンが押されたときのみ読み込む
```

### オプション2: メタデータのみの軽量検索

全文テキストを除外したメタデータのみのリストを作成：

```python
# 軽量版のメタデータリスト（full_textなし）
@st.cache_data(ttl=3600)
def list_metadata_only(_s3_client) -> List[Dict]:
    """メタデータのみのリスト（全文テキスト除外）"""
    # メタデータのみを返す（軽量）
```

### オプション3: 検索結果のページネーション

大量の検索結果を分割表示：

```python
# 20件ずつ表示
page_size = 20
total_pages = (len(search_results) + page_size - 1) // page_size
```

---

## 📈 パフォーマンス測定

### 現在の処理時間（目安）

- **初回データ読み込み**: 30-60秒（1,223ファイル）
- **検索処理**: 5-15秒（キーワード検索の場合）
- **2回目以降**: キャッシュにより高速化

### 改善目標

- **初回データ読み込み**: 10-20秒
- **検索処理**: 2-5秒
- **2回目以降**: 1秒以内

---

## 💡 推奨される次のステップ

1. **メタデータのみのインデックス作成**（最優先）
2. **ページネーションの導入**
3. **並列処理の実装**
4. **Streamlit Teamプランへのアップグレード検討**

---

## 🆘 緊急時の対策

処理が遅すぎる場合の一時的な対策：

1. **キャッシュをクリアして再起動**
   - Streamlit Cloudのダッシュボードで「Clear cache」
   - その後「Reboot app」

2. **検索条件を絞り込む**
   - 日付・時間・放送局を指定して検索範囲を縮小

3. **キーワード検索を避ける**
   - キーワード検索は全文テキストをスキャンするため重い
   - 日付・時間・放送局のみで検索

